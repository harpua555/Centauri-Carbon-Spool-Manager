name: Create Release

on:
  push:
    tags:
      - 'v*'  # Trigger on tags like v1.0.0

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4

      - name: Create release archive
        run: |
          # Create a clean directory structure for the release
          mkdir -p release/config/packages
          mkdir -p release/config/dashboards

          # Copy package files
          cp config/packages/elegoo_spool_manager.yaml release/config/packages/
          cp config/packages/elegoo_spool_history.yaml release/config/packages/

          # Copy dashboard files
          cp config/lovelace-spool-manager.yaml release/config/
          cp config/dashboards/elegoo_spool_manager_simple.yaml release/config/dashboards/
          cp config/dashboards/elegoo_spool_manager_card.yaml release/config/dashboards/
          cp config/dashboards/elegoo_spool_manager_with_history.yaml release/config/dashboards/
          cp config/dashboards/spool_1_history.yaml release/config/dashboards/

          # Copy documentation
          cp README.md release/
          cp SPOOL_MANAGER.md release/
          cp SPOOL_HISTORY_GUIDE.md release/
          cp LICENSE release/

          # Create installation script
          cat > release/install.sh << 'EOF'
          #!/bin/bash
          # Centauri Carbon Spool Manager Installation Script

          echo "Centauri Carbon Spool Manager Installer"
          echo "========================================"
          echo ""

          # Detect Home Assistant config directory
          if [ -d "/config" ]; then
            CONFIG_DIR="/config"
          elif [ -d "$HOME/.homeassistant" ]; then
            CONFIG_DIR="$HOME/.homeassistant"
          else
            echo "Enter your Home Assistant config directory path:"
            read -r CONFIG_DIR
          fi

          echo "Installing to: $CONFIG_DIR"
          echo ""

          # Create directories if they don't exist
          mkdir -p "$CONFIG_DIR/packages"
          mkdir -p "$CONFIG_DIR/dashboards"

          # Copy package files
          echo "Installing package files..."
          cp config/packages/*.yaml "$CONFIG_DIR/packages/"

          # Ask about dashboard
          echo ""
          echo "Choose dashboard installation:"
          echo "1) Full dashboard (lovelace-spool-manager.yaml)"
          echo "2) Simple card (elegoo_spool_manager_simple.yaml)"
          echo "3) Card with history (elegoo_spool_manager_with_history.yaml)"
          echo "4) All of the above"
          echo "5) Skip dashboard installation"
          read -r -p "Enter choice [1-5]: " choice

          case $choice in
            1)
              cp config/lovelace-spool-manager.yaml "$CONFIG_DIR/"
              echo "Installed full dashboard"
              ;;
            2)
              cp config/dashboards/elegoo_spool_manager_simple.yaml "$CONFIG_DIR/dashboards/"
              echo "Installed simple card"
              ;;
            3)
              cp config/dashboards/elegoo_spool_manager_with_history.yaml "$CONFIG_DIR/dashboards/"
              echo "Installed card with history"
              ;;
            4)
              cp config/lovelace-spool-manager.yaml "$CONFIG_DIR/"
              cp config/dashboards/*.yaml "$CONFIG_DIR/dashboards/"
              echo "Installed all dashboards"
              ;;
            5)
              echo "Skipped dashboard installation"
              ;;
            *)
              echo "Invalid choice, skipping dashboard installation"
              ;;
          esac

          echo ""
          echo "Installation complete!"
          echo ""
          echo "Next steps:"
          echo "1. Add 'packages: !include_dir_named packages' to your configuration.yaml"
          echo "2. If you installed lovelace-spool-manager.yaml, add it to your lovelace dashboards"
          echo "3. Restart Home Assistant"
          echo "4. See README.md for configuration instructions"
          EOF

          chmod +x release/install.sh

          # Create ZIP archive
          cd release
          zip -r ../centauri-carbon-spool-manager.zip .
          cd ..

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Centauri Carbon Spool Manager v${{ steps.version.outputs.VERSION }}
          body: |
            # Centauri Carbon Spool Manager v${{ steps.version.outputs.VERSION }}

            Automatic filament tracking for your Elegoo Centauri Carbon (and other FDM printers).

            ## Installation

            1. Download `centauri-carbon-spool-manager.zip`
            2. Extract the archive
            3. Run `./install.sh` or manually copy files to your Home Assistant config
            4. See `README.md` for detailed setup instructions

            ## Requirements

            - Home Assistant instance
            - [Elegoo Printer Integration](https://github.com/danielcherubini/elegoo-homeassistant) already installed
            - Elegoo FDM printer with extrusion sensor (Centauri Carbon, Neptune 4, etc.)

            ## What's Included

            - Spool manager package files (4 spools with material/density support)
            - Print history tracking with undo functionality
            - Multiple dashboard options (full, simple, with history)
            - Complete documentation and guides
            - Installation script for easy setup

            ## Features

            - Real-time extrusion tracking
            - Weight and length calculations
            - Material density profiles
            - Print history logging
            - Undo last print
            - Multiple dashboard views

            For complete features and setup instructions, see README.md
          files: |
            centauri-carbon-spool-manager.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
